(function(){var Bullet,CheckState,Counter,GameOverState,Jubiol,KawazSprite,Level,Level1,LogoScene,MainScene,MainState,Player,ReadyState,Stage,State,StateManager,Timer,TitleScene,Vector;var __hasProp=Object.prototype.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key)){child[key]=parent[key]}}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};Vector=(function(){function Vector(x,y){if(x==null){x=0}if(y==null){y=0}this.set(x,y)}Vector.prototype.set=function(x,y){if(x==null){x=0}if(y==null){y=0}this.x=x;this.y=y;return this};Vector.prototype.add=function(v){this.x+=v.x;this.y+=v.y;return this};Vector.prototype.sub=function(v){this.x-=v.x;this.y-=v.y;return this};Vector.prototype.scale=function(n){this.x*=n;this.y*=n;return this};Vector.prototype.div=function(n){this.x/=n;this.y/=n;return this};Vector.prototype.product=function(v){return this.x*v.x+this.y*v.y};Vector.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};Vector.prototype.truncate=function(n){if(this.length()){this.scale(n/this.length())}return this};Vector.prototype.normalize=function(){return this.truncate(1)};Vector.prototype.angle=function(){return(180*Math.atan2(this.y,this.x))/Math.PI};Vector.prototype.rotate=function(deg){var rad,size;rad=(deg*Math.PI)/180;size=this.length();this.x=Math.sin(rad)*this.y+Math.cos(rad)*this.x;this.y=Math.cos(rad)*this.y-Math.sin(rad)*this.x;return this.truncate(size)};Vector.prototype.clone=function(){return new Vector(this.x,this.y)};Vector.prototype.reverse=function(){this.x*=-1;this.y*=-1;return this};return Vector})();Array.prototype._index=function(index){var length;if(index<0){length=this.length;return length+index}return index};Array.prototype.at=function(index){return this[this._index(index)]};Array.prototype.map=function(func){var value,_ref;return([].splice.apply(this,[0,this.length-0].concat(_ref=(function(){var _i,_len,_results;_results=[];for(_i=0,_len=this.length;_i<_len;_i++){value=this[_i];_results.push(func(value))}return _results}).call(this))),_ref)};Array.prototype.clone=function(){return this.dup()};Array.prototype.dup=function(){return this.slice(0,this.length)};Array.prototype.each=function(func){var index,_ref;for(index=0,_ref=this.length;0<=_ref?index<_ref:index>_ref;0<=_ref?index++:index--){func(this[index],index)}return this};Array.prototype.deleteAt=function(index){index=this._index(index);if(index>=this.length){return}return this.splice(index,1)};Array.prototype.deleteIf=function(func){var i;return this.replace((function(){var _ref,_results;_results=[];for(i=0,_ref=this.length;0<=_ref?i<_ref:i>_ref;0<=_ref?i++:i--){if(!func(this[i],i)){_results.push(this[i])}}return _results}).call(this))};Array.prototype.reject=function(func){var before;before=this.length;this.deleteIf(func);if(before===this.length){return}return this};Array.prototype.isEmpty=function(){return this.length===0};Array.prototype.isEql=function(other,eql){var index,_ref;if(eql==null){eql=function(a,b){return a===b}}if(this.length!==other.length){return false}for(index=0,_ref=this.length;0<=_ref?index<_ref:index>_ref;0<=_ref?index++:index--){if(!eql(this[index],other[index])){return false}}return true};Array.prototype.fill=function(val,start,end){var i,_ref;if(start==null){start=0}if(end==null){end=this.length-1}start=this._index(start);end=this._index(end);[].splice.apply(this,[start,end-start+1].concat(_ref=(function(){var _results;_results=[];for(i=start;start<=end?i<=end:i>=end;start<=end?i++:i--){_results.push(val)}return _results})())),_ref;return this};Array.prototype.first=function(){return this[0]};Array.prototype.last=function(){var last;last=this._index(-1);return this[last]};Array.prototype.uniq=function(eql){var array,val,_i,_len;if(eql==null){eql=function(a,b){return a===b}}array=[];for(_i=0,_len=this.length;_i<_len;_i++){val=this[_i];if(!array.isInclude(val,eql)){array.push(val)}}return this.replace(array)};Array.prototype.index=function(value,eql){var index,_ref;if(eql==null){eql=function(a,b){return a===b}}for(index=0,_ref=this.length;0<=_ref?index<_ref:index>_ref;0<=_ref?index++:index--){if(eql(this[index],value)){return index}}return};Array.prototype.indexes=function(){var index,_i,_len,_results;_results=[];for(_i=0,_len=arguments.length;_i<_len;_i++){index=arguments[_i];_results.push(this.at(index))}return _results};Array.prototype.rindex=function(value,eql){var index,_ref;if(eql==null){eql=function(a,b){return a===b}}for(index=_ref=this.length;_ref<=0?index<0:index>0;_ref<=0?index++:index--){if(eql(this[index],value)){return index}}return};Array.prototype.flatten=function(){return this.replace(this.reduce(function(a,b){return a.concat(b instanceof Array?b.flatten():b)},[]))};Array.prototype.transpose=function(){var h,i,t,w,x,y;w=this.isEmpty()?0:this.length;h=this.first() instanceof Array?this.first().length:0;if(!w||!h){return this}t=(function(){var _results;_results=[];for(i=0;0<=h?i<h:i>h;0<=h?i++:i--){_results.push([])}return _results})();for(x=0;0<=w?x<w:x>w;0<=w?x++:x--){for(y=0;0<=h?y<h:y>h;0<=h?y++:y--){t[y][x]=this[x][y]}}return this.replace(t)};Array.prototype.compact=function(){return this.deleteIf(function(value){return value===void 0})};Array.prototype.isInclude=function(val,eql){var elem,_i,_len;if(eql==null){eql=function(a,b){return a===b}}for(_i=0,_len=this.length;_i<_len;_i++){elem=this[_i];if(eql(elem,val)){return true}}return false};Array.prototype.size=function(){return this.length};Array.prototype.swap=function(a,b){var tmp;a=this._index(a);b=this._index(b);tmp=this[a];this[a]=this[b];this[b]=tmp;return this};Array.prototype.shuffle=function(){var i,_ref;for(i=0,_ref=this.length;0<=_ref?i<_ref:i>_ref;0<=_ref?i++:i--){this.swap(i,Math.floor(Math.random()*this.length))}return this};Array.prototype.choice=function(){return this[Math.floor(Math.random()*this.length)]};Array.prototype.count=function(val,eql){var index,sum,_ref;if(eql==null){eql=function(a,b){return a===b}}sum=0;for(index=0,_ref=this.length;0<=_ref?index<_ref:index>_ref;0<=_ref?index++:index--){if(eql(this[index],val)){++sum}}return sum};Array.prototype.replace=function(other){var elem,_i,_len;this.clear();for(_i=0,_len=other.length;_i<_len;_i++){elem=other[_i];this.push(elem)}return this};Array.prototype.nitems=function(){return this.clone().compact().size()};Array.prototype.insert=function(){var args,i,index,values,_ref;args=Array.prototype.slice.call(arguments,0,arguments.length);if(args.size()<=1){return this}index=this._index(args[0]);values=args.slice(1,this.length);for(i=0,_ref=values.length;0<=_ref?i<_ref:i>_ref;0<=_ref?i++:i--){this.splice(index+i,0,values[i])}return this};Array.prototype.clear=function(){var _results;_results=[];while(!this.isEmpty()){_results.push(this.deleteAt(0))}return _results};Array.prototype.max=function(cmp){var result;if(cmp==null){cmp=function(a,b){if(a===b){return 0}if(a<b){return -1}else{return 1}}}result=this.first();this.reduce(function(a,b){if(cmp(result,b)<0){return result=b}});return result};Array.prototype.min=function(cmp){var result;if(cmp==null){cmp=function(a,b){if(a===b){return 0}if(a<b){return -1}else{return 1}}}result=this.first();this.reduce(function(a,b){if(cmp(result,b)>=0){return result=b}});return result};Timer=(function(){function Timer(max,repeat,time,active,complete){if(repeat==null){repeat=false}if(time==null){time=0}if(active==null){active=false}if(complete==null){complete=void 0}this.set(max);this._time=time;this._active=active;this._complete=complete;this._repeat=repeat}Timer.prototype.set=function(max){if(max==null){max=0}this._max=max;return this};Timer.prototype.play=function(){this._active=true;return this};Timer.prototype.stop=function(){this._active=false;this._time=0;return this};Timer.prototype.pause=function(){this._active=false;return this};Timer.prototype.reset=function(){this._time=0;return this};Timer.prototype.tick=function(){if(this._time<this._max&&this._active){++this._time;if(this._time===this._max){if(this._complete!=null){this._complete()}if(this._repeat){this._time=0}}}return this};Timer.prototype.now=function(){return this._time};Timer.prototype.setComplete=function(func){this._complete=func;return this};Timer.prototype.setRepeat=function(repeat){this._repeat=repeat;return this};Timer.prototype.isActive=function(){return this._active};Timer.prototype.isOver=function(){return this._time>=this._max};return Timer})();enchant();Jubiol=(function(){Jubiol.prototype.config={WIDTH:640,HEIGHT:480,FPS:30,FONT:"Helvetica",IMAGE_PATH:"resources/images/",IMAGES:["miku.gif","bullet.png","bullet1.png","font.png","kawaz.png"],SOUND_PATH:"resources/sounds/",SOUNDS:[],INITIAL_LEVEL:1};function Jubiol(){var image,root,_i,_len,_ref;this.game=new Game(this.config.WIDTH,this.config.HEIGHT);this.game.fps=this.config.FPS;this.game.keybind(90,"a");this.game.keybind(88,"b");Jubiol.game=this.game;Jubiol.config=this.config;_ref=this.config.IMAGES;for(_i=0,_len=_ref.length;_i<_len;_i++){image=_ref[_i];this.game.preload(""+this.config.IMAGE_PATH+image)}root=new LogoScene();this.game.onload=function(){root.setup();return this.pushScene(root)};this.game.start()}return Jubiol})();window.onload=function(){return new Jubiol()};StateManager=(function(){function StateManager(rootState){this.stack=[];this.pushState(rootState)}StateManager.prototype.pushState=function(state){if(state!=null){state.setup()}return this.stack.push(state)};StateManager.prototype.popState=function(){var state;state=this.stack.pop();state.teardown();return state};StateManager.prototype.replaceState=function(state){this.popState();return this.pushState(state)};StateManager.prototype.currentState=function(){return this.stack.last()};return StateManager})();State=(function(){function State(scene){this.scene=scene!=null?scene:Jubiol.game.currentScene;""}State.prototype.setup=function(){return this};State.prototype.teardown=function(){return this};State.prototype.update=function(){return true};return State})();ReadyState=(function(){__extends(ReadyState,State);function ReadyState(){ReadyState.__super__.constructor.apply(this,arguments)}ReadyState.prototype.setup=function(){this.timer=new Timer(600);this.label=new Label("");return this.timer.play()};ReadyState.prototype.update=function(){this.timer.tick();if(this.timer.now()===30){this.label.text="Ready";this.label.x=220;this.label.y=200;this.label.font="64px "+Jubiol.config.FONT;this.scene.addChild(this.label)}else{if(this.timer.now()===60){this.scene.removeChild(this.label);return new MainState(this.scene)}}return true};return ReadyState})();MainState=(function(){__extends(MainState,State);function MainState(){MainState.__super__.constructor.apply(this,arguments);this.stage=this.scene.stage;this.stage.changeLevel(1)}MainState.prototype.setup=function(){var label;label=new Label("");label.text="Go";label.font="64px "+Jubiol.config.FONT;label.x=270;label.y=200;label.addEventListener("enterframe",function(){this.y-=30;if(this.y<0){return this.parentNode.removeChild(this)}});return this.scene.addChild(label)};MainState.prototype.update=function(){this.scene.counter.update();if(this.scene.stage.update()){return new CheckState()}return true};return MainState})();CheckState=(function(){__extends(CheckState,State);function CheckState(){CheckState.__super__.constructor.apply(this,arguments)}CheckState.prototype.setup=function(){this.checkTimer=new Timer(45);return this.checkTimer.play()};CheckState.prototype.update=function(){this.scene.counter.update();this.checkTimer.tick();if(this.checkTimer.isOver()){return this.checkDeath()}return true};CheckState.prototype.checkDeath=function(){var rate;rate=this.scene.counter.calcRate();if(rate<0.05){console.log("OK");this.scene.stage.player.invincibleTimer.play();return false}else{console.log("NG");return new GameOverState()}};return CheckState})();GameOverState=(function(){__extends(GameOverState,State);function GameOverState(){GameOverState.__super__.constructor.apply(this,arguments)}GameOverState.prototype.setup=function(){var gameover,label,replay,title,_i,_len,_ref;gameover=new Label("Game Over");gameover.x=150;gameover.y=200;gameover.width=500;gameover.scaleX=5;gameover.scaleY=5;replay=new Label("Replay(z)");title=new Label("Title(x)");replay.x=180;replay.y=300;title.x=350;title.y=300;_ref=[replay,title,gameover];for(_i=0,_len=_ref.length;_i<_len;_i++){label=_ref[_i];label.font="32px "+Jubiol.config.FONT;this.scene.addChild(label)}return gameover.font="64px "+Jubiol.config.FONT};GameOverState.prototype.update=function(){if(Jubiol.game.input.a){Jubiol.game.replaceScene(new MainScene())}else{if(Jubiol.game.input.b){Jubiol.game.replaceScene(new TitleScene())}}return true};return GameOverState})();Level=(function(){Level.prototype.level=0;function Level(stage){this.stage=stage;this}Level.prototype.setup=function(){return this};Level.prototype.teardown=function(){return this};Level.prototype.getBullet=function(){var bullet;return bullet=new Bullet(Math.random()*Jubiol.config.WIDTH,0)};Level.prototype.popEnemy=function(bullets){var bullet;bullet=this.getBullet();if(bullet.red){++Jubiol.game.stage.total}return bullets.addChild(bullet)};Level.prototype.isClear=function(){return false};return Level})();Level1=(function(){__extends(Level1,Level);function Level1(){Level1.__super__.constructor.apply(this,arguments)}Level1.prototype.level=1;return Level1})();Stage=(function(){__extends(Stage,Group);function Stage(){Stage.__super__.constructor.apply(this,arguments);this.player=new Player(138,288);this.addChild(this.player);this.bullets=new Group();this.addChild(this.bullets)}Stage.prototype.update=function(e){var bullet,_i,_len,_ref,_ref2;if((_ref=this.level)!=null){_ref.popEnemy(this.bullets)}this.player.update();_ref2=this.bullets.childNodes.clone();for(_i=0,_len=_ref2.length;_i<_len;_i++){bullet=_ref2[_i];bullet.update();if(!this.player.invincibleTimer.isActive()&&this.player.within(bullet,10)){return true}}return false};Stage.prototype.changeLevel=function(lv){var label,levelClass;levelClass=eval("Level"+lv);this.level=new levelClass(this);label=new Label("Level "+lv);label.font="32px "+Jubiol.config.FONT;label.x=-50;label.y=440;label.addEventListener("enterframe",function(){this.x+=20;if(this.x>Jubiol.config.WIDTH){return this.parentNode.removeChild(this)}});console.log("new Level");return this.addChild(label)};return Stage})();Counter=(function(){function Counter(){this.count=0;this.total=0;this.pressA=false}Counter.prototype.update=function(){if(Jubiol.game.input.a){if(!this.pressA){++this.count;this.pressA=true;return console.log(this.count)}}else{return this.pressA=false}};Counter.prototype.calcRate=function(){if(this.total){return Math.abs(this.total-this.count)/this.total}return 1};return Counter})();KawazSprite=(function(){__extends(KawazSprite,Sprite);function KawazSprite(w,h,x,y){if(x==null){x=0}if(y==null){y=0}KawazSprite.__super__.constructor.call(this,w,h);this.removeEventListener("enterframe");this.x=x;this.y=y;this.v=new Vector()}KawazSprite.prototype.update=function(e){this.x+=this.v.x;return this.y+=this.v.y};KawazSprite.prototype.setImage=function(fileName){return this.image=Jubiol.game.assets[""+Jubiol.config.IMAGE_PATH+fileName]};return KawazSprite})();Player=(function(){__extends(Player,KawazSprite);function Player(x,y){if(x==null){x=0}if(y==null){y=0}Player.__super__.constructor.call(this,42,32,x,y);this.setImage("miku.gif");this.speed=7;this.invincibleTimer=new Timer(45);this.invincibleTimer.setComplete(function(){return this.stop()})}Player.prototype.update=function(e){this.invincibleTimer.tick();this.opacity=0.5+0.5*Math.cos(this.invincibleTimer.now()*30*Math.PI/180);this.v.set(0,0);if(Jubiol.game.input.left){this.v.x=-1}else{if(Jubiol.game.input.right){this.v.x=1}}if(Jubiol.game.input.up){this.v.y=-1}else{if(Jubiol.game.input.down){this.v.y=1}}this.v.truncate(this.speed);Player.__super__.update.apply(this,arguments);if(this.x>Jubiol.config.WIDTH-this.width){this.x=Jubiol.config.WIDTH-this.width}else{if(this.x<0){this.x=0}}if(this.y>Jubiol.config.HEIGHT-this.height){return this.y=Jubiol.config.HEIGHT-this.height}else{if(this.y<0){return this.y=0}}};return Player})();Bullet=(function(){__extends(Bullet,KawazSprite);function Bullet(x,y){var rand;if(x==null){x=0}if(y==null){y=0}Bullet.__super__.constructor.call(this,12,12,x,y);rand=Math.random()*100;if(rand<5){this.setImage("bullet1.png");this.red=true}else{this.setImage("bullet.png");this.red=false}}Bullet.prototype.update=function(e){this.v.y=10;Bullet.__super__.update.apply(this,arguments);if(this.x<0||this.x>Jubiol.config.WIDTH||this.y<0||this.y>Jubiol.config.HEIGHT){return Jubiol.game.stage.bullets.removeChild(this)}};return Bullet})();LogoScene=(function(){__extends(LogoScene,Scene);function LogoScene(){LogoScene.__super__.constructor.apply(this,arguments)}LogoScene.prototype.setup=function(){this.kawaz=new KawazSprite(253,81);this.kawaz.setImage("kawaz.png");this.kawaz.x=193.5;this.kawaz.y=220;this.kawaz.opacity=0;this.addChild(this.kawaz);this.addEventListener("enterframe",this.update);this.timer=new Timer(180);this.timer.setComplete(function(){return Jubiol.game.replaceScene(new MainScene())});return this.timer.play()};LogoScene.prototype.update=function(){if(Jubiol.game.input.a){Jubiol.game.replaceScene(new MainScene())}this.timer.tick();if(this.timer.now()<60){return this.kawaz.opacity+=1/60}else{if(this.timer.now()>120){return this.kawaz.opacity-=1/60}}};return LogoScene})();TitleScene=(function(){__extends(TitleScene,Scene);function TitleScene(){TitleScene.__super__.constructor.apply(this,arguments);this.label=new Label("Jubiol");this.label.font="96px "+Jubiol.config.FONT;this.label.color="#222";this.label.x=185;this.label.y=-50;this.addEventListener("enterframe",this.update);this.addChild(this.label)}TitleScene.prototype.update=function(){var kawaz,play;if(!(this.label.y>=70)){return this.label.y+=3}else{if(this.label.y===70){play=new Label("Play");kawaz=new Label("Kawaz");play.x=295;play.y=270;play.font="36px "+Jubiol.config.FONT;kawaz.x=280;kawaz.y=340;kawaz.font="36px "+Jubiol.config.FONT;this.addChild(play);return this.addChild(kawaz)}}};return TitleScene})();MainScene=(function(){__extends(MainScene,Scene);function MainScene(){MainScene.__super__.constructor.apply(this,arguments);this.stateManager=new StateManager(new ReadyState(this));this.stage=new Stage();Jubiol.game.stage=this.stage;this.addChild(this.stage);this.counter=new Counter();this.addEventListener("enterframe",this.update);this.addEventListener("exit",function(){return this.removeEventListener("enterframe")})}MainScene.prototype.update=function(e){var state;state=this.stateManager.currentState().update();if(state===false){return this.stateManager.popState()}else{if(state!==true){return this.stateManager.pushState(state)}}};return MainScene})()}).call(this);